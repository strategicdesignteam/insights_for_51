---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# Addresses maintenance plan 19045 (ose-master01.strategicdesign.io)
# https://access.redhat.com/insights/planner/19045
# Generated by Red Hat Insights on Fri, 02 Jun 2017 14:27:05 GMT
# Warning: Some of the rules in the plan do not have Ansible support and this playbook does not address them!

# Kernel vulnerable to local privilege escalation via n_hdlc module (CVE-2017-2636)
# Identifier: (CVE_2017_2636_kernel|KERNEL_CVE_2017_2636,105,mitigate)
# Version: 73ce59d190b34351078f6e89f80851427ca7b800
- name: Disable n_hdlc kernel module
  hosts: "ose-app-node01.strategicdesign.io"
  become: true

  tasks:
    # While this module may already be disabled in a different file,
    # create a blacklist file explicitly for this issue.
    - name: Blacklisting the n_hdlc module
      lineinfile:
        dest: /etc/modprobe.d/disable-n_hdlc.conf
        line: "install n_hdlc /bin/true"
        owner: root
        group: root
        mode: 0644
        state: present
        create: yes

    # Ensure that the module is not currently loaded
    - name: Checking loaded modules
      command: awk /^n_hdlc/ /proc/modules
      register: loaded_modules
      changed_when: false
      check_mode: no
      
    # If the module was found, a reboot is necessary
    - when: "{{ loaded_modules.stdout | default('') | search('n_hdlc') }}"
      block:
        - name: Reboot if module was loaded
          shell: shutdown -r now "Ansible triggered reboot"
          async: 1
          poll: 0
          ignore_errors: true

        - name: Wait for system to boot up
          local_action: wait_for host={{ inventory_hostname }} port=22 state=started delay=15 timeout=300
          become: false



- name: run insights
  hosts: ose-app-node01.strategicdesign.io
  become: True
  tasks:
    - name: run insights
      command: redhat-access-insights
      changed_when: false